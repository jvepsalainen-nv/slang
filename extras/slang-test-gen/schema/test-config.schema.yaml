# YAML Schema for Slang Test Configuration
# This schema defines the structure for general-purpose Slang test generation

$schema: "http://json-schema.org/draft-07/schema#"
title: Slang Test Configuration
description: Schema for configuring Slang test generation from templates

type: object
required:
  - test_config
  - variants

properties:
  test_config:
    type: object
    description: Global test configuration
    required:
      - name
      - shader_template
    properties:
      name:
        type: string
        description: Name of the test suite
        pattern: "^[a-z][a-z0-9_-]*$"
        examples:
          - texture_capability
          - lambda_basic
          - generics_constraints

      description:
        type: string
        description: Description of what this test suite covers

      shader_template:
        type: string
        description: |
          Path to shader template file or inline shader code.
          If a file path exists, it will be loaded; otherwise treated as inline code.
        examples:
          - "./templates/base-shader.slang"
          - "void main() { ... }"

      output_dir:
        type: string
        description: |
          Output directory for generated test files (relative to Slang repository root).
          The generator will search for the repository root by looking for .git directory.
          If not specified, uses command-line --output-dir or current directory.
        examples:
          - "tests/capability/texture-types"
          - "tests/language-feature/lambda"
          - "tests/compute"

      output_pattern:
        type: string
        description: |
          Pattern for output filenames. Available placeholders:
          - {name}: Test suite name
          - {variant_name}: Variant name
        default: "{name}-{variant_name}.slang"
        examples:
          - "{variant_name}.slang"
          - "gen-{name}-{variant_name}.slang"

      generation_comment:
        type: string
        description: Comment to include at top of generated files
        examples:
          - "Generated by slang-test-gen.py from config/my-config.yaml"

      global_inputs:
        type: array
        description: Test inputs shared across all variants
        items:
          $ref: "#/definitions/TestInput"

      global_template_vars:
        type: object
        description: Template variables shared across all variants
        additionalProperties: true

      default_filecheck_patterns:
        type: object
        description: |
          Default FileCheck patterns inherited by all variants.
          Variants can override these by specifying their own filecheck_patterns.
        additionalProperties:
          type: array
          items:
            type: string
        examples:
          - POSITIVE: ["result code = 0"]
            RESULT: ["42"]

      default_directives:
        type: array
        description: |
          Default test directives used by variants that don't specify their own directives.
          If a variant specifies any directives, defaults are not used.
        items:
          $ref: "#/definitions/TestDirective"

  variants:
    type: object
    description: Map of variant name to variant configuration
    additionalProperties:
      $ref: "#/definitions/TestVariant"

definitions:
  TestInput:
    type: object
    description: Defines a test input (buffer, texture, sampler, etc.)
    required:
      - name
      - type
    properties:
      name:
        type: string
        description: Name of the input variable

      type:
        type: string
        description: Type of test input
        examples:
          - ubuffer
          - Texture2D
          - Texture3D
          - Sampler
          - RWStructuredBuffer

      parameters:
        type: string
        description: Parameters for the test input
        examples:
          - "data=[0], stride=4"
          - "size=4, content=zero"
          - "filteringMode=point"
          - "depthCompare"

      declaration:
        type: string
        description: Optional Slang declaration for the input
        examples:
          - "RWStructuredBuffer<int> outputBuffer;"
          - "Texture2D<float4> myTexture;"
          - "SamplerState samplerState;"

  TestVariant:
    type: object
    description: A single test variant
    properties:
      description:
        type: string
        description: Description of this variant

      directives:
        type: array
        description: Test directives (//TEST:... lines)
        items:
          $ref: "#/definitions/TestDirective"

      inputs:
        type: array
        description: Additional test inputs specific to this variant
        items:
          $ref: "#/definitions/TestInput"

      template_vars:
        type: object
        description: Template variables for this variant (merged with global)
        additionalProperties: true

      shader_code:
        type: string
        description: Optional shader code to use instead of template

      additional_header:
        type: string
        description: Additional header content after inputs

      filecheck_patterns:
        type: object
        description: FileCheck patterns for verification
        additionalProperties:
          type: array
          items:
            type: string
        examples:
          - POSITIVE:
              - "result code = 0"
              - "POSITIVE-NOT: error"
            NEGATIVE:
              - "error [[:digit:]]+"

  TestDirective:
    type: object
    description: A test directive line
    required:
      - type
      - flags
    properties:
      type:
        type: string
        description: Type of test
        enum:
          - SIMPLE
          - COMPARE_COMPUTE
          - INTERPRET
          - CROSS_COMPILE
          - COMPILE_FAIL
          - CUSTOM
        default: SIMPLE

      flags:
        type: string
        description: Test flags/command-line options
        examples:
          - "-entry fragMain -stage fragment -target spirv"
          - "-cpu -output-using-type"
          - "-vk -emit-spirv-via-glsl"

      filecheck:
        type: string
        description: FileCheck pattern name
        examples:
          - POSITIVE
          - NEGATIVE
          - CHECK
          - RESULT

      enabled:
        type: boolean
        description: Whether this test is enabled
        default: true

      disable_reason:
        type:
          - string
          - integer
        description: |
          Reason for disabling (GitHub issue number or explanation).
          If integer, will generate link to GitHub issue.
        examples:
          - 1234
          - "Not yet implemented"
          - "Known bug in SPIR-V backend"

examples:
  - test_config:
      name: simple_compute
      description: "Simple compute shader tests"
      shader_template: "./shader.slang"
      output_pattern: "{variant_name}.slang"
      generation_comment: "Generated by test generator"
      global_inputs:
        - name: outputBuffer
          type: ubuffer
          parameters: "data=[0], stride=4"
          declaration: "RWStructuredBuffer<int> outputBuffer;"
      global_template_vars:
        BUFFER_SIZE: 4

    variants:
      basic:
        description: "Basic compute test"
        directives:
          - type: COMPARE_COMPUTE
            flags: "-cpu -output-using-type"
            filecheck: RESULT
            enabled: true
        filecheck_patterns:
          RESULT:
            - "12345"

      disabled_test:
        description: "Disabled test example"
        directives:
          - type: SIMPLE
            flags: "-target spirv"
            filecheck: CHECK
            enabled: false
            disable_reason: 8786

